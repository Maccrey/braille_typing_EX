<!DOCTYPE html>
<html>
<head>
    <title>Statistics Debug</title>
</head>
<body>
    <h1>Statistics Debug Page</h1>

    <div id="debug-output"></div>
    <div id="manual-stats"></div>

    <button onclick="testStatistics()">Test Statistics API</button>
    <button onclick="testWithExistingUser()">Test with Existing User</button>

    <script>
    async function testStatistics() {
        const output = document.getElementById('debug-output');
        output.innerHTML = '<h2>Testing Statistics...</h2>';

        try {
            // Create a new user
            const username = `debugtest_${Date.now()}`;
            const signupResponse = await fetch('http://localhost:3001/api/auth/signup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password: 'password123' })
            });

            if (!signupResponse.ok) {
                throw new Error(`Signup failed: ${signupResponse.status}`);
            }

            const signupData = await signupResponse.json();
            const token = signupData.token;

            output.innerHTML += `<p>✅ Created user: ${username}</p>`;

            // Add practice data
            const practiceResponse = await fetch('http://localhost:3001/api/protected/practice/log', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    duration_seconds: 180,
                    practiced_at: '2025-09-28'
                })
            });

            if (!practiceResponse.ok) {
                throw new Error(`Practice log failed: ${practiceResponse.status}`);
            }

            const practiceData = await practiceResponse.json();
            output.innerHTML += `<p>📝 Added practice: ${JSON.stringify(practiceData)}</p>`;

            // Get statistics
            const statsResponse = await fetch('http://localhost:3001/api/profile/stats', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!statsResponse.ok) {
                throw new Error(`Stats failed: ${statsResponse.status}`);
            }

            const statsData = await statsResponse.json();
            output.innerHTML += `<h3>📊 Statistics Response:</h3><pre>${JSON.stringify(statsData, null, 2)}</pre>`;

            // Store token for manual testing
            localStorage.setItem('debugToken', token);
            output.innerHTML += `<p>🔑 Token stored in localStorage as 'debugToken'</p>`;

        } catch (error) {
            output.innerHTML += `<p style="color: red;">❌ Error: ${error.message}</p>`;
        }
    }

    async function testWithExistingUser() {
        const output = document.getElementById('debug-output');
        const token = localStorage.getItem('debugToken');

        if (!token) {
            output.innerHTML = '<p>No debug token found. Run "Test Statistics API" first.</p>';
            return;
        }

        try {
            // Test the same endpoint that statistics.js uses
            const baseUrl = window.location.hostname === 'localhost' ? 'http://localhost:3001' : '';
            const apiUrl = baseUrl + '/api/profile/stats';

            output.innerHTML = `<h2>Testing with existing token...</h2>`;
            output.innerHTML += `<p>🔗 Using URL: ${apiUrl}</p>`;

            const response = await fetch(apiUrl, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            output.innerHTML += `<p>📡 Response status: ${response.status}</p>`;

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const data = await response.json();
            output.innerHTML += `<h3>📊 Current Statistics:</h3><pre>${JSON.stringify(data, null, 2)}</pre>`;

            // Format like the frontend would
            const totalMinutes = Math.round(data.total_practice_time / 60);
            const avgMinutes = data.total_practice_sessions > 0
                ? Math.round(data.total_practice_time / data.total_practice_sessions / 60)
                : 0;
            const weeklyMinutes = Math.round(data.weekly_practice_time / 60);

            const manualStats = document.getElementById('manual-stats');
            manualStats.innerHTML = `
                <h3>📊 나의 학습 통계</h3>
                <div>총 연습 시간: ${totalMinutes}분</div>
                <div>총 연습 세션: ${data.total_practice_sessions}회</div>
                <div>평균 세션 시간: ${avgMinutes}분</div>
                <div>연습한 일수: ${data.total_practice_days}일</div>
                <div>주간 연습 시간: ${weeklyMinutes}/300분</div>
                <div>주간 연습 일수: ${data.weekly_practice_days}/5일</div>
            `;

        } catch (error) {
            output.innerHTML += `<p style="color: red;">❌ Error: ${error.message}</p>`;
        }
    }
    </script>
</body>
</html>