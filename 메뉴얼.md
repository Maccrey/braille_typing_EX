# 점자 타자 연습기 - 개발자 및 관리자 메뉴얼

## 목차

- [시스템 개요](#시스템-개요)
- [기술 스택](#기술-스택)
- [프로젝트 구조](#프로젝트-구조)
- [설치 및 실행](#설치-및-실행)
- [데이터베이스 구조](#데이터베이스-구조)
- [API 엔드포인트](#api-엔드포인트)
- [주요 기능 구현](#주요-기능-구현)
- [보안 및 인증](#보안-및-인증)
- [배포 가이드](#배포-가이드)
- [문제 해결](#문제-해결)
- [유지보수 가이드](#유지보수-가이드)

---

## 시스템 개요

### 프로젝트 설명

시각장애인을 위한 웹 기반 점자 타자 연습 애플리케이션입니다. 사용자는 점자 입력 연습, 학습 기록 추적, 커뮤니티 활동 등을 할 수 있습니다.

### 핵심 기능

1. **인증 시스템**: JWT 기반 회원가입/로그인
2. **점자 연습**: F,D,S,J,K,L 키를 이용한 점자 입력 연습
3. **학습 관리**: Excel 파일 업로드를 통한 학습 자료 생성
4. **통계 및 출석**: 연습 시간 추적 및 출석 달력
5. **커뮤니티**: 게시글/댓글 기능
6. **관리자 기능**: 백업/복구, 사용자 관리

### 개발 원칙

- **TDD (Test-Driven Development)**: Jest + Playwright
- **문서 중심 개발**: PRD, tasklist.md 기반
- **Conventional Commits**: feat, fix, test, refactor, docs

---

## 기술 스택

### Backend

- **런타임**: Node.js v18+
- **프레임워크**: Express.js
- **데이터베이스**: SQLite3
- **인증**: JWT (jsonwebtoken) + bcrypt
- **파일 업로드**: Multer
- **Excel 파싱**: xlsx

### Frontend

- **프레임워크**: Vanilla JavaScript (프레임워크 없음)
- **스타일링**: CSS3 (다크모드 지원)
- **API 통신**: Fetch API
- **TTS**: Web Speech API

### 테스트

- **Backend**: Jest + Supertest
- **Frontend**: Playwright (E2E)

### 배포

- **호스팅**: Render.com
- **CI/CD**: GitHub Actions
- **환경변수**: .env (dotenv)

---

## 프로젝트 구조

```
braille_typing_EX/
├── backend/
│   ├── app.js                    # Express 앱 설정
│   ├── server.js                 # 서버 시작 (PORT 3001)
│   ├── init-db.js                # 데이터베이스 초기화
│   ├── database.db               # SQLite 데이터베이스 파일
│   ├── config/
│   │   └── database.js           # DB 연결 설정
│   ├── controllers/
│   │   ├── authController.js     # 인증 로직
│   │   ├── dataController.js     # 카테고리/즐겨찾기
│   │   ├── practiceController.js # 연습 세션 로깅
│   │   ├── profileController.js  # 사용자 통계
│   │   ├── uploadController.js   # Excel 업로드
│   │   ├── postsController.js    # 커뮤니티 게시글
│   │   ├── commentsController.js # 댓글
│   │   └── adminController.js    # 관리자 기능
│   ├── middleware/
│   │   ├── authMiddleware.js     # JWT 검증
│   │   ├── validation.js         # 입력 검증
│   │   ├── errorHandler.js       # 에러 핸들링
│   │   └── lazyDbInit.js         # DB 지연 초기화
│   ├── routes/
│   │   ├── authRoutes.js         # /api/auth/*
│   │   ├── protectedRoutes.js    # /api/protected/*
│   │   ├── practiceRoutes.js     # /api/practice/*
│   │   ├── profileRoutes.js      # /api/profile/*
│   │   ├── posts.js              # /api/posts/*
│   │   ├── comments.js           # /api/comments/*
│   │   └── admin.js              # /api/admin/*
│   └── __tests__/                # Jest 테스트
│       ├── auth.test.js
│       ├── data.test.js
│       ├── practice.test.js
│       └── community.test.js
├── frontend/
│   ├── index.html                # 랜딩 페이지
│   ├── login.html                # 로그인
│   ├── signup.html               # 회원가입
│   ├── main.html                 # 메인 대시보드
│   ├── practice.html             # 점자 연습
│   ├── upload.html               # 파일 업로드
│   ├── statistics.html           # 통계 상세
│   ├── css/
│   │   └── dark-mode.css         # 다크모드 스타일
│   ├── js/
│   │   ├── main.js               # 메인 로직
│   │   ├── practice.js           # 점자 연습 로직
│   │   ├── community.js          # 커뮤니티 기능
│   │   ├── dark-mode.js          # 다크모드 토글
│   │   ├── storage-cleaner.js    # 로컬스토리지 관리
│   │   └── anti-loop.js          # 무한 루프 방지
│   └── tests/                    # Playwright 테스트
│       ├── login.spec.js
│       ├── practice.spec.js
│       └── community.spec.js
├── CLAUDE.md                     # Claude Code 프로젝트 가이드
├── prd.md                        # 제품 요구사항 문서
├── tasklist.md                   # 작업 목록
├── 사용설명서.md                  # 사용자 매뉴얼
└── 메뉴얼.md                      # 이 문서
```

---

## 설치 및 실행

### 1. 프로젝트 클론

```bash
git clone <repository-url>
cd braille_typing_EX
```

### 2. Backend 설정

```bash
cd backend
npm install
node init-db.js  # 데이터베이스 초기화
npm start        # 서버 시작 (포트 3001)
```

### 3. Frontend 설정

```bash
cd frontend
npm install
npx http-server -p 8080  # 개발 서버 (포트 8080)
```

### 4. 환경변수 설정 (.env)

```bash
# backend/.env
PORT=3001
SESSION_SECRET=your-secret-key-change-in-production
NODE_ENV=development

# JWT 설정 (선택사항, 기본값 사용 가능)
JWT_SECRET=your-jwt-secret
JWT_EXPIRES_IN=24h
```

### 5. 테스트 실행

```bash
# Backend 테스트
cd backend
npm test

# Frontend E2E 테스트
cd frontend
npm test
```

---

## 데이터베이스 구조

### ERD 요약

```
Users (1) ----< (N) Categories
Users (1) ----< (N) PracticeLogs
Users (1) ----< (N) Attendance
Users (1) ----< (N) WorkLogs
Users (1) ----< (N) Favorites
Users (1) ----< (N) Posts
Users (1) ----< (N) Comments
Categories (1) ----< (N) BrailleData
Categories (1) ----< (N) Favorites
Posts (1) ----< (N) Comments
```

### 주요 테이블

#### Users

```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE NOT NULL,
    password TEXT NOT NULL,
    is_admin INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### Categories

```sql
CREATE TABLE categories (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    description TEXT,
    created_by INTEGER NOT NULL,
    is_public INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(name, created_by),
    FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE CASCADE
);
```

#### BrailleData

```sql
CREATE TABLE braille_data (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    category_id INTEGER NOT NULL,
    character TEXT NOT NULL,
    description TEXT,
    braille_pattern TEXT NOT NULL,  -- JSON: [[1,2], [3]]
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE CASCADE
);
```

#### PracticeLogs

```sql
CREATE TABLE practice_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    duration_seconds INTEGER NOT NULL,
    practiced_at DATE NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

#### Attendance

```sql
CREATE TABLE attendance (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    date DATE NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, date),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

#### WorkLogs

```sql
CREATE TABLE work_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    date DATE NOT NULL,
    check_in_time DATETIME,
    check_out_time DATETIME,
    work_duration_seconds INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, date),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

#### Posts

```sql
CREATE TABLE posts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

#### Comments

```sql
CREATE TABLE comments (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    post_id INTEGER NOT NULL,
    user_id INTEGER NOT NULL,
    parent_id INTEGER,
    content TEXT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (post_id) REFERENCES posts(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (parent_id) REFERENCES comments(id) ON DELETE CASCADE
);
```

#### Favorites

```sql
CREATE TABLE favorites (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    category_id INTEGER NOT NULL,
    favorited_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, category_id),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE CASCADE
);
```

---

## API 엔드포인트

### 인증 (Authentication)

| Method | Endpoint                    | 설명               | 인증 필요 |
| ------ | --------------------------- | ------------------ | --------- |
| POST   | `/api/auth/signup`          | 회원가입           | ❌        |
| POST   | `/api/auth/login`           | 로그인             | ❌        |
| POST   | `/api/auth/logout`          | 로그아웃           | ❌        |
| GET    | `/api/auth/user`            | 현재 사용자 정보   | ✅        |
| POST   | `/api/auth/change-password` | 비밀번호 변경      | ✅        |
| GET    | `/api/auth/check-username`  | 사용자명 중복 확인 | ❌        |

#### 예시: 회원가입

**Request:**

```http
POST /api/auth/signup
Content-Type: application/json

{
  "username": "testuser",
  "password": "password123"
}
```

**Response:**

```json
{
  "message": "회원가입이 완료되었습니다.",
  "user": {
    "id": 1,
    "username": "testuser"
  }
}
```

### 카테고리 및 데이터 관리

| Method | Endpoint                                             | 설명               | 인증 필요 |
| ------ | ---------------------------------------------------- | ------------------ | --------- |
| GET    | `/api/protected/categories/my`                       | 내 카테고리 목록   | ✅        |
| GET    | `/api/protected/categories/search?q={keyword}`       | 공개 카테고리 검색 | ✅        |
| DELETE | `/api/protected/categories/:categoryId`              | 카테고리 삭제      | ✅        |
| PUT    | `/api/protected/categories/:categoryId`              | 카테고리 수정      | ✅        |
| GET    | `/api/protected/categories/:categoryId/braille-data` | 점자 데이터 조회   | ✅        |
| PUT    | `/api/protected/categories/:categoryId/braille-data` | 점자 데이터 수정   | ✅        |
| GET    | `/api/protected/braille/:categoryId/random`          | 랜덤 문제 가져오기 | ✅        |

#### 예시: 랜덤 문제 가져오기

**Request:**

```http
GET /api/protected/braille/5/random
Authorization: Bearer eyJhbGci...
```

**Response:**

```json
{
  "id": 123,
  "character": "α",
  "description": "그리스 문자 알파",
  "braille_pattern": "[[1]]"
}
```

### 즐겨찾기

| Method | Endpoint                               | 설명          | 인증 필요 |
| ------ | -------------------------------------- | ------------- | --------- |
| GET    | `/api/protected/favorites`             | 즐겨찾기 목록 | ✅        |
| POST   | `/api/protected/favorites`             | 즐겨찾기 추가 | ✅        |
| DELETE | `/api/protected/favorites/:categoryId` | 즐겨찾기 제거 | ✅        |

### 파일 업로드

| 구분      | 경로/엔드포인트                                   | 설명                                                                       | 인증 필요 |
| --------- | ------------------------------------------------- | ---------------------------------------------------------------------------- | --------- |
| Client    | `window.apiClient.createCategoryWithBrailleData`  | 브라우저에서 Excel을 파싱해 Firebase(Firestore)로 직접 업로드               | ✅        |
| GET       | `/api/protected/download-example` (fallback 지원) | 예제 파일 다운로드<br>API 실패 시 `assets/examples/braille-example.xlsx` 사용 | ✅        |

#### 예시: Excel 업로드

1. 사용자가 `upload.html`에서 Excel 파일을 선택하면 브라우저가 `xlsx` 라이브러리를 이용해 내용을 파싱합니다.
2. 각 행은 `문자` + 최대 3개의 블록 열로 구성되며, 셀 안의 숫자(1~6)를 점자 점 번호로 해석합니다.
3. 파싱 결과가 검증되면 `window.apiClient.createCategoryWithBrailleData`를 호출해 Firestore에 카테고리와 점자 데이터를 한 번에 저장합니다.
4. 업로드가 완료되면 성공 메시지를 표시하고 메인 페이지로 리다이렉션합니다.

### 연습 로그

| Method | Endpoint                      | 설명           | 인증 필요 |
| ------ | ----------------------------- | -------------- | --------- |
| POST   | `/api/protected/practice/log` | 연습 시간 기록 | ✅        |

#### 예시: 연습 시간 기록

**Request:**

```http
POST /api/protected/practice/log
Authorization: Bearer eyJhbGci...
Content-Type: application/json

{
  "duration_seconds": 300,
  "practiced_at": "2025-09-22"
}
```

### 프로필 및 통계

| Method | Endpoint                         | 설명           | 인증 필요 |
| ------ | -------------------------------- | -------------- | --------- |
| GET    | `/api/profile/stats`             | 사용자 통계    | ✅        |
| GET    | `/api/profile/daily-ranking`     | 일일 랭킹      | ✅        |
| POST   | `/api/profile/check-in`          | 출근 체크인    | ✅        |
| POST   | `/api/profile/check-out`         | 퇴근 체크아웃  | ✅        |
| GET    | `/api/profile/work-status/:date` | 근무 상태 조회 | ✅        |

### 커뮤니티

| Method | Endpoint                     | 설명                 | 인증 필요 |
| ------ | ---------------------------- | -------------------- | --------- |
| GET    | `/api/posts`                 | 게시글 목록 (페이징) | ✅        |
| GET    | `/api/posts/:id`             | 게시글 상세          | ✅        |
| POST   | `/api/posts`                 | 게시글 작성          | ✅        |
| PUT    | `/api/posts/:id`             | 게시글 수정          | ✅        |
| DELETE | `/api/posts/:id`             | 게시글 삭제          | ✅        |
| GET    | `/api/comments/post/:postId` | 댓글 목록            | ✅        |
| POST   | `/api/comments`              | 댓글 작성            | ✅        |
| PUT    | `/api/comments/:id`          | 댓글 수정            | ✅        |
| DELETE | `/api/comments/:id`          | 댓글 삭제            | ✅        |

### 관리자 (Admin Only)

| Method | Endpoint             | 설명             | 인증 필요   |
| ------ | -------------------- | ---------------- | ----------- |
| GET    | `/api/admin/stats`   | 시스템 통계      | ✅ (관리자) |
| GET    | `/api/admin/users`   | 사용자 목록      | ✅ (관리자) |
| GET    | `/api/admin/backup`  | DB 백업 다운로드 | ✅ (관리자) |
| POST   | `/api/admin/restore` | DB 복구          | ✅ (관리자) |

---

## 주요 기능 구현

### 1. 점자 입력 시스템 (Frontend)

#### 키보드 매핑

```
점자 격자:
1 • • 4
2 • • 5
3 • • 6

키보드:
F → 점 1 (왼쪽 위)
D → 점 2 (왼쪽 중간)
S → 점 3 (왼쪽 아래)
J → 점 4 (오른쪽 위)
K → 점 5 (오른쪽 중간)
L → 점 6 (오른쪽 아래)
```

#### 핵심 로직 (`frontend/js/practice.js`)

```javascript
class BraillePractice {
  constructor() {
    this.currentChar = null;
    this.currentBraillePattern = null; // [[1,2], [3]] 형식
    this.currentBlockIndex = 0;
    this.pressedDots = new Set();
  }

  toggleDot(dotNumber) {
    if (this.pressedDots.has(dotNumber)) {
      this.pressedDots.delete(dotNumber);
    } else {
      this.pressedDots.add(dotNumber);
    }

    this.checkCurrentBlock();
  }

  checkCurrentBlock() {
    const correctPattern = this.currentBraillePattern[this.currentBlockIndex];
    const pressedArray = Array.from(this.pressedDots).sort();
    const correctArray = [...correctPattern].sort();

    if (pressedArray.length >= correctArray.length) {
      this.validateCurrentBlock(pressedArray, correctArray);
    }
  }
}
```

#### 멀티블록 점자 처리

```javascript
// 예시: "γ" = [[1,4], [2,5]]
createBrailleBlocks() {
  this.currentBraillePattern.forEach((blockPattern, blockIndex) => {
    const block = this.createSingleBrailleBlock(blockPattern, blockIndex);
    container.appendChild(block);
  });
}
```

### 2. Excel 파일 업로드 및 파싱

#### Excel 형식

| A열 (문자) | B열 (블록1) | C열 (블록2) | D열 (블록3) |
| ---------- | ----------- | ----------- | ----------- |
| α          | 1           |             |             |
| β          | 1,2         |             |             |
| γ          | 1,4         | 2,5         |             |
| δ          | 1,4,5       |             |             |

#### 파싱 로직 (`frontend/js/upload.js`)

브라우저가 직접 파싱하며, `xlsx` CDN을 사용해 파일을 메모리에서 처리합니다.

```javascript
async function parseExcelFile(file) {
  const arrayBuffer = await file.arrayBuffer();
  const workbook = XLSX.read(arrayBuffer, { type: "array" });
  const sheet = workbook.Sheets[workbook.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, blankrows: false });

  const entries = [];
  rows.forEach((row, index) => {
    const character = (row[0] ?? "").toString().trim();
    const isHeaderRow = index === 0 && /문자|character/i.test(character);
    if (!character || isHeaderRow) return;

    const brailleBlocks = extractBrailleBlocksFromRow(row);
    if (brailleBlocks.length === 0) return;

    entries.push({
      character,
      braille_pattern: brailleBlocks,
      order: entries.length
    });
  });

  if (entries.length === 0) {
    throw new Error("점자 데이터를 찾을 수 없습니다.");
  }

  return entries;
}
```

파싱된 결과는 곧바로 `window.apiClient.createCategoryWithBrailleData`에 전달되어 Firestore에 저장됩니다. 업로드 로직은 온전히 클라이언트에서 실행되므로 별도 Node.js 백엔드나 Cloudtype 환경이 필요하지 않습니다.

### 3. 세션 추적 및 통계

#### 연습 시간 추적 (`frontend/js/practice.js`)

```javascript
class BraillePractice {
  startPractice(categoryId) {
    this.sessionStartTime = Date.now();
    this.practiceSessionData = {
      startTime: this.sessionStartTime,
      charactersCompleted: 0,
      totalTime: 0,
    };

    // UI 업데이트 타이머 시작
    this.startUIUpdates();
  }

  async endPracticeSession() {
    const totalSessionDuration = Math.floor(
      (Date.now() - this.sessionStartTime) / 1000
    );

    if (totalSessionDuration >= 10) {
      await this.recordPracticeSession(totalSessionDuration);
    }
  }

  async recordPracticeSession(duration) {
    const response = await fetch("/api/protected/practice/log", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${token}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        duration_seconds: duration,
        practiced_at: new Date().toISOString().split("T")[0],
      }),
    });
  }
}
```

#### 출석 달력 렌더링 (`frontend/js/main.js`)

```javascript
async function loadAttendanceCalendar() {
  const response = await fetch("/api/profile/stats", {
    headers: { Authorization: `Bearer ${token}` },
  });

  const data = await response.json();
  const attendanceDates = data.attendance.map((a) => a.date);

  // 달력 그리드 생성
  const calendarGrid = document.getElementById("calendar-grid");
  const firstDay = new Date(currentYear, currentMonth, 1).getDay();
  const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

  for (let i = 0; i < firstDay; i++) {
    // 빈 셀
  }

  for (let day = 1; day <= daysInMonth; day++) {
    const dateString = `${currentYear}-${String(currentMonth + 1).padStart(
      2,
      "0"
    )}-${String(day).padStart(2, "0")}`;
    const cell = createDateCell(day);

    if (attendanceDates.includes(dateString)) {
      cell.classList.add("attended");
    }

    calendarGrid.appendChild(cell);
  }
}
```

### 4. 커뮤니티 기능

#### 게시글 3줄 미리보기 (`frontend/js/community.js`)

```javascript
function renderPost(post) {
  const postContent = document.createElement("div");
  postContent.className = "post-content collapsed";
  postContent.textContent = post.content;

  // 3줄 이상이면 축소 상태
  postContent.addEventListener("click", (e) => {
    e.stopPropagation();
    postContent.classList.toggle("collapsed");
    postContent.classList.toggle("expanded");
  });
}
```

#### 댓글/답글 시스템 (`backend/controllers/commentsController.js`)

```javascript
async function createComment(req, res) {
  const { post_id, content, parent_id } = req.body;
  const userId = req.user.userId;

  const result = await db.run(
    `
    INSERT INTO comments (post_id, user_id, parent_id, content)
    VALUES (?, ?, ?, ?)
  `,
    [post_id, userId, parent_id || null, content]
  );

  res.json({
    success: true,
    comment: {
      id: result.lastID,
      post_id,
      user_id: userId,
      parent_id,
      content,
      created_at: new Date(),
    },
  });
}
```

---

## 보안 및 인증

### JWT 토큰 구조

```javascript
// 토큰 생성
const jwt = require("jsonwebtoken");

const token = jwt.sign(
  { userId: user.id, username: user.username },
  process.env.JWT_SECRET || "default-secret",
  { expiresIn: "24h" }
);
```

### 인증 미들웨어 (`backend/middleware/authMiddleware.js`)

```javascript
function authenticateToken(req, res, next) {
  const authHeader = req.headers["authorization"];
  const token = authHeader && authHeader.split(" ")[1]; // "Bearer TOKEN"

  if (!token) {
    return res.status(401).json({ error: "인증 토큰이 필요합니다." });
  }

  jwt.verify(token, process.env.JWT_SECRET || "default-secret", (err, user) => {
    if (err) {
      return res.status(403).json({ error: "유효하지 않은 토큰입니다." });
    }
    req.user = user;
    next();
  });
}
```

### 관리자 권한 확인 (`backend/middleware/authMiddleware.js`)

```javascript
function isAdmin(req, res, next) {
  if (!req.user || req.user.isAdmin !== 1) {
    return res.status(403).json({ error: "관리자 권한이 필요합니다." });
  }
  next();
}

// 사용 예시
router.get("/admin/users", authenticateToken, isAdmin, getAllUsers);
```

### 비밀번호 해싱

```javascript
const bcrypt = require("bcrypt");

// 회원가입 시
const hashedPassword = await bcrypt.hash(password, 10);

// 로그인 시
const isValid = await bcrypt.compare(inputPassword, hashedPassword);
```

### CORS 설정 (`backend/app.js`)

```javascript
app.use(
  cors({
    origin: true,
    credentials: true,
    methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
    allowedHeaders: ["Content-Type", "Authorization"],
  })
);
```

---

## 배포 가이드

### Render.com 배포 (현재 설정)

#### 1. Render.yaml 설정

```yaml
services:
  - type: web
    name: braille-typing-ex
    env: node
    buildCommand: npm install --prefix backend && npm install --prefix frontend
    startCommand: node backend/server.js
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3001
      - key: SESSION_SECRET
        generateValue: true
      - key: JWT_SECRET
        generateValue: true
```

#### 2. 환경변수 설정 (Render 대시보드)

- `NODE_ENV`: production
- `PORT`: 3001
- `SESSION_SECRET`: (자동 생성)
- `JWT_SECRET`: (자동 생성)

#### 3. 자동 배포 트리거

- GitHub main 브랜치에 push 시 자동 배포
- `DEPLOY_TRIGGER.md` 파일 수정으로 강제 배포 가능

### 로컬 개발 환경

#### 개발 서버 실행

```bash
# Backend (터미널 1)
cd backend
npm run dev  # nodemon으로 자동 재시작

# Frontend (터미널 2)
cd frontend
npx http-server -p 8080
```

#### 테스트 실행

```bash
# Backend 테스트
cd backend
npm test -- --verbose

# Frontend E2E 테스트
cd frontend
npm test
```

### 데이터베이스 마이그레이션

#### 새 테이블 추가 시

1. `backend/init-db.js` 수정
2. 로컬에서 테스트: `node backend/init-db.js`
3. Render 배포 시 자동으로 DB 초기화 실행

#### 데이터 백업/복구

```bash
# 관리자 패널에서 "백업 다운로드" 버튼 클릭
# → backup_YYYY-MM-DD_HH-mm-ss.json 다운로드

# 복구: 관리자 패널에서 JSON 파일 업로드
```

---

## 문제 해결

### 일반적인 문제

#### 1. 키보드 입력이 안 됨

**증상**: F,D,S,J,K,L 키를 눌러도 반응 없음

**해결방법**:

```javascript
// 1. 브라우저 포커스 확인
document.body.focus();

// 2. 이벤트 리스너 디버깅
console.log("Key pressed:", event.key);

// 3. CSS 클래스 충돌 확인
// .active, .correct, .wrong 클래스의 우선순위 확인
```

#### 2. API 500 에러

**증상**: `/api/protected/practice/log` 호출 시 500 에러

**해결방법**:

```bash
# 1. DB 테이블 확인
sqlite3 backend/database.db ".tables"

# 2. 누락된 테이블 생성
node backend/init-db.js

# 3. 로그 확인
tail -f backend/logs/error.log
```

#### 3. 로그인 루프

**증상**: 로그인 후 계속 index.html로 리다이렉트

**해결방법**:

```javascript
// frontend/js/anti-loop.js 확인
// localStorage에서 리다이렉트 기록 확인
console.log(localStorage.getItem("redirectHistory"));

// 강제 초기화
localStorage.clear();
```

#### 4. 점자 블록이 화면 밖으로 나감

**증상**: 멀티블록 문자에서 블록이 잘림

**해결방법**:

```javascript
// frontend/js/practice.js
adjustBrailleBlockSizes() {
  const containerWidth = container.offsetWidth;
  const blockCount = this.currentBraillePattern.length;

  // 스케일 조정
  let scale = Math.min(1, containerWidth / (blockCount * 100));
  document.documentElement.style.setProperty('--braille-block-scale', scale);
}
```

### 데이터베이스 문제

#### 테이블 초기화

```bash
# 모든 테이블 삭제 후 재생성
rm backend/database.db
node backend/init-db.js
```

#### 데이터 무결성 확인

```sql
-- 외래 키 제약조건 확인
PRAGMA foreign_keys = ON;

-- 고아 레코드 확인
SELECT * FROM braille_data
WHERE category_id NOT IN (SELECT id FROM categories);
```

### 성능 최적화

#### 인덱스 추가

```sql
-- 자주 검색되는 컬럼에 인덱스
CREATE INDEX idx_categories_created_by ON categories(created_by);
CREATE INDEX idx_braille_data_category_id ON braille_data(category_id);
CREATE INDEX idx_practice_logs_user_id ON practice_logs(user_id);
```

#### API 응답 캐싱

```javascript
// 예시: 공개 카테고리 목록 캐싱 (5분)
const NodeCache = require("node-cache");
const cache = new NodeCache({ stdTTL: 300 });

async function getPublicCategories(req, res) {
  const cacheKey = "public_categories";
  const cached = cache.get(cacheKey);

  if (cached) {
    return res.json(cached);
  }

  const categories = await db.all(
    "SELECT * FROM categories WHERE is_public = 1"
  );
  cache.set(cacheKey, categories);
  res.json(categories);
}
```

---

## 유지보수 가이드

### 정기 작업

#### 매주

- [ ] 에러 로그 확인 (`backend/logs/`)
- [ ] 데이터베이스 백업
- [ ] 디스크 용량 확인

#### 매월

- [ ] 의존성 업데이트 (`npm outdated`)
- [ ] 보안 취약점 확인 (`npm audit`)
- [ ] 사용자 피드백 검토

#### 분기별

- [ ] 성능 벤치마크
- [ ] 데이터베이스 최적화 (VACUUM)
- [ ] 테스트 커버리지 확인

### 코드 리뷰 체크리스트

#### Backend

- [ ] 모든 API에 인증 미들웨어 적용
- [ ] SQL 인젝션 방지 (파라미터 바인딩)
- [ ] 에러 핸들링 추가
- [ ] 입력 검증 (validation.js)
- [ ] 테스트 코드 작성

#### Frontend

- [ ] XSS 방지 (textContent 사용)
- [ ] CSRF 토큰 확인 (필요시)
- [ ] 로딩 상태 표시
- [ ] 에러 메시지 사용자 친화적
- [ ] E2E 테스트 추가

### 로그 관리

#### 로그 레벨

```javascript
// backend/middleware/errorHandler.js
const winston = require("winston");

const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || "info",
  format: winston.format.json(),
  transports: [
    new winston.transports.File({ filename: "error.log", level: "error" }),
    new winston.transports.File({ filename: "combined.log" }),
  ],
});

logger.info("User logged in", { userId: 123 });
logger.error("Database error", { error: err.message });
```

#### 로그 로테이션

```bash
# logrotate 설정 (/etc/logrotate.d/braille-app)
/path/to/backend/logs/*.log {
  daily
  rotate 7
  compress
  delaycompress
  notifempty
  create 0644 www-data www-data
}
```

### 모니터링

#### 헬스체크 엔드포인트

```javascript
// backend/app.js
app.get("/health", (req, res) => {
  res.status(200).json({
    status: "UP",
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
  });
});
```

#### Uptime 모니터링

- UptimeRobot 또는 Pingdom 사용
- 엔드포인트: `https://braille-typing-ex.onrender.com/health`
- 체크 주기: 5분

---

## 추가 리소스

### 문서

- [PRD (제품 요구사항)](./prd.md)
- [사용설명서](./사용설명서.md)
- [CLAUDE.md (프로젝트 가이드)](./CLAUDE.md)
- [Tasklist (작업 목록)](./tasklist.md)

### 외부 참조

- [Express.js 문서](https://expressjs.com/)
- [JWT.io](https://jwt.io/)
- [SQLite 문서](https://www.sqlite.org/docs.html)
- [Playwright 문서](https://playwright.dev/)

### 기여 가이드

1. Fork 프로젝트
2. Feature 브랜치 생성 (`git checkout -b feature/AmazingFeature`)
3. 변경사항 커밋 (`git commit -m 'feat: Add some AmazingFeature'`)
4. 브랜치에 Push (`git push origin feature/AmazingFeature`)
5. Pull Request 생성

---

**최종 업데이트**: 2025-10-02
**버전**: 1.0.0
**작성자**: Claude (Anthropic).
